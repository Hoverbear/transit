<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel=stylesheet href=/c3.css>
        <script src=/d3.js></script>
        <script src=/c3.js></script>
    </head>
    <body>
        <main>
            <section><!-- Placeholder --></section>
        </main>
        <script>
            window.onload = function init() {
                console.log("Initializing...");
                window.dispatchEvent(new CustomEvent("build_form"));
            }
            window.addEventListener("build_form", function build_form() {
                console.log("Building form...");
                var main = document.querySelector("main"),
                    formNode = document.importNode(document.querySelector("#form").content, true);
                main.replaceChild(formNode, main.querySelector("section"));
            });
            window.addEventListener("build_loader", function build_loader(event) {
                console.log("Building loader...");
                var main = document.querySelector("main"),
                    loaderNode = document.importNode(document.querySelector("#loader").content, true);
                main.replaceChild(loaderNode, main.querySelector("section"));
                // Make the request and process the data.
                // Make request.
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/api?" + event.detail, true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.addEventListener("load", function (event) {
                    if (xhr.readyState === 4) { // Complete
                        if (xhr.status === 200) {
                            // Preprocess data.
                            // C3 is fairly opinionated about how data should be structured.
                            var times = [], moves = [], additions = [], deletions = [];
                            JSON.parse(xhr.responseText).map(function (output) {
                                // Use new time since it's when the actual change happened.
                                times.push(new Date(output.new_time * 1000)); // JS is milliseconds, rust is seconds.
                                moves.push(output.outputs.reduce(function (sum, val) {
                                    return sum + val.num_lines;
                                }, 0));
                                additions.push(0); // TODO
                                deletions.push(0); // TODO
                            });
                            // Emit draw event.
                            window.dispatchEvent(new CustomEvent("build_viewer", { detail: {
                                times: times,
                                moves: moves,
                                additions: additions,
                                deletions: deletions,
                            }}));
                        } else {
                            window.dispatchEvent(new CustomEvent("build_error", { detail: xhr.responseText }));
                        }
                    }
                });
                xhr.addEventListener("error", function(event) {
                    alert("There was an error.");
                });
                xhr.send(null);
            });
            window.addEventListener("build_viewer", function build_form(event) {
                console.log("Building viewer...");
                var main = document.querySelector("main"),
                    viewerNode = document.importNode(document.querySelector("#viewer").content, true);
                main.replaceChild(viewerNode, main.querySelector("section"));
                // Create chart.
                c3.generate({
                    data: {
                        x: 'times',
                        json: event.detail,
                        types: {
                            moves: "area",
                            additions: "area",
                            deletions: "area",
                        },
                        groups: [[ "moves", "additions", "deletions" ]],
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                centered: true,
                                format: '%Y-%m-%d'
                            }
                        }
                    },
                    subchart: {
                        show: true,
                    },
                });
            });
        </script>
        <template id=viewer>
            <section>
                <div id="chart">
            </section>
        </template>
        <template id=loader>
            <section>
                <p>Loadering!</p>
            </section>
        </template>
        <template id=form>
            <section>
                <form>
                    <legend>Transit Query</legend>
                    <label for=repo>Repository</label>
                    <input id=repo>
                    <label for=old>Old Commit ID</label>
                    <input id=old>
                    <label for=new>New Commit ID</label>
                    <input id=new>
                    <input type=submit value=Query>
                </form>
                <script>
                    // https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Forms/Sending_forms_through_JavaScript
                    document.querySelector("form").addEventListener("submit", function submit(event) {
                        console.log("Submitting...");
                        event.preventDefault();
                        var query = [];
                        // Build query
                        ["repo", "old", "new"].forEach(function (val) {
                            var node = document.getElementById(val),
                                id = node.id,
                                value = node.value;
                            if (id && value) {
                                query.push(encodeURIComponent(id) + "=" + encodeURIComponent(value));
                            }
                        });
                        query = query.join('&').replace(/%20/g, '+');
                        window.dispatchEvent(new CustomEvent("build_loader", { detail: query }));
                        return false;
                    });
                </script>
            </section>
        </template>
    </body>
</html>
